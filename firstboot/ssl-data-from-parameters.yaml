heat_template_version: 2015-04-30

description: >
  This is a template which will build the TLS Certificates necessary
  for the load balancer using the given parameters.

parameters:
  # Can be overriden via parameter_defaults in the environment
  SSLCertificate:
    default: ''
    description: If set, the contents of an SSL certificate .crt file for encrypting SSL endpoints.
    type: string
    hidden: true
  SSLCertificatePath:
    description: The filepath of the certificate as it will be stored in the controller.
    type: string
    default: '/etc/pki/tls/private/overcloud_endpoint.pem'
    hidden: true
  SSLKey:
    default: ''
    description: If set, the contents of an SSL certificate .key file for encrypting SSL endpoints.
    type: string
    hidden: true

resources:
  userdata:
    type: OS::Heat::MultipartMime
    properties:
      parts:
      - config: {get_resource: controller_ssl_config}

  controller_ssl_config:
    type: OS::Heat::CloudConfig
    properties:
      cloud_config:
        write_files:
            - path: {get_param: SSLCertificatePath}
            permissions: 0440
            owner: root:haproxy
            content:
              str_replace:
                template: |
                  certificate
                  private_key
                params:
                  certificate: {get_param: SSLCertificate}
                  private_key: {get_param: SSLKey}

outputs:
  OS::stack_id:
    value: {get_resource: userdata}
